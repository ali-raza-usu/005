package aspects.encyption;

import java.security.Key;

import joinpoints.communication.SendEventJP;

import org.apache.log4j.Logger;

import utilities.Encoder;
import utilities.Message;
import baseaspects.communication.OneWayReceiveAspect;
import baseaspects.communication.OneWaySendAspect;

public aspect DecryptionAspect extends OneWayReceiveAspect
{
	private Logger logger = Logger.getLogger(OneWaySendAspect.class);			
	public byte[] encryptedMessage;
	
	Object around (SendEventJP _sendEventJp): ConversationEnds(_sendEventJp)
	{
		Message msg =  (Message)Encoder.decode(_sendEventJp.getBytes());
		String name = "Server", password = "abcdef";
		
		
		if (msg.getClass().getSimpleName()=="Server")
		{
			//KMClient keyClient = new KMClient();
			KeyManager kmanager = new KeyManager();
			try 
			{
				Encryption encryption = new Encryption();
				if (kmanager.authenticate(name, password) == true)
				{
					
					SharedKey sKey = (SharedKey) encryption.getSharedKey();
					encryptedMessage = encryption.Encrypt(msg, (Key)sKey);
					System.out.println(encryptedMessage);
				}
			} catch (Exception e) {
				
				e.printStackTrace();
			}
			_sendEventJp.setBytes(Encoder.encode(msg));
		}
		return proceed(_sendEventJp);
	}
}
